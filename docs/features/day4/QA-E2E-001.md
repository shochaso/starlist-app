Status:: 
Source-of-Truth:: (TBD)
Spec-State:: 
Last-Updated:: 


# QA-E2E-001 — Day4 E2E テスト / CI 体制

Status: aligned-with-Flutter  
Last-Updated: 2025-11-07  
Source-of-Truth: Flutter code (`lib/src/features/**`)

> 責任者: QA リード（TBD）／実装: QA チーム

## 共通前提（SoT=Flutter/RLS原則/OPS命名）

- **Source of Truth**: Flutter実装を最優先とし、仕様は実装追従
- **RLS原則**: Supabase AuthセッションとPostgres RLSを完全同期、`v_entitlements_effective` で購読判定
- **OPS命名**: 監査イベントを統一（`auth.*`, `auth.sync.dryrun`, `rls.access.denied`, `ops.subscription.price_*`）
- **依存**: PAY-STAR-SUBS-PER-STAR-PRICING（スター単位可変価格）

## 1. 目的

- Day4 で導入する OAuth / RLS / UI 変更を E2E で自動検証し、CI/CD に組み込む。
- 失敗時は詳細ログを `audit_auth` と紐づけ、デバッグ時間を短縮する。

## 2. スコープ

- シナリオ: Google サインイン、Apple サインイン、プロバイダリンク、再認証、購読可視性、監視連携。
- プラットフォーム: Flutter Web / Chrome Headless、API: Edge Functions, Supabase。

## 3. 仕様要点（Reality → Target）

- 現状: `AUTH_OAUTH_V1` / `AUTH_SYNC_DRY_RUN` といった Feature Flag は `.env.example` に未定義。E2E は既存フロー（メールログイン + 固定価格）だけを手動で確認。  
- Target: Playwright or Flutter integration tests をベースに、Feature Flag ON/OFF 双方を検証。  
  - FF=OFF: 現行メールログイン + 固定価格 UI の回帰。  
  - FF=ON: OAuth UI、再認証モーダル、スター単位可変価格 UI をモックで検証。  
- テスト完了後、`QA-E2E-001` のレポートを `docs/reports/` へ出力し、Dry-runログ (`auth.sync.dryrun`, `ops.subscription.price_selected`) を添付。

## 4. 依存関係

- AUTH-OAUTH-001（UI/Edge 統合）
- SEC-RLS-SYNC-001（購読差分チェック）
- OPS-MONITORING-001（失敗イベント通知）

## 5. テスト観点

- Google/Apple それぞれのサインイン → auth-sync 完了 → UI 反映（※OAuthはモックで代替）。  
- 401/403 からの再認証モーダルとリトライ成功（仕様のみ、現状は失敗ログ確認まで）。  
- 解約 → RLS 反映 → UI 非表示 → 再購読で復帰（現状は `subscriptions` 直接参照）。  
- 監視メトリクスに E2E 試行が記録されること (`auth.sync.dryrun`, `auth.login.success`).  
- スター単位可変価格: 成人/未成年別の推奨価格・注意文言が UI に表示されるか。  
- 価格入力ガード（下限/上限/通貨フォーマット）でバリデーションが発火するか。

## 6. 完了条件

- CI で Day4 E2E ジョブが緑で完走し、アーティファクトが保存される。  
- Mermaid Day4 クラスタで `QA-E2E-001` と PAY-STAR-SUBS-PER-STAR-PRICING のリンクが有効。  
- 失敗時の Slack 通知が QA チャンネルに届く。  
- `.env.example` の FF を利用した ON/OFF テストが実施される。

---

## 差分サマリ (Before/After)

- **Before**: OAuth/再認証/Dry-run/可変価格テストが既に存在する前提。  
- **After**: 現在はメールログイン + 固定価格のみであることを明記し、FF とモックを使った段階的テスト計画を追加。  
- **追加**: 可変価格（成人/未成年）の表示確認、OPS ログの検証項目を追記。
