# Supabase Storage 運用ガイド

## 🎯 目的
STARLISTプロジェクトにおけるSupabase Storageの安全で効率的な運用を確保する

## 📦 バケット構成

### 公開バケット
| バケット名 | 用途 | アクセス権限 | 署名URL有効期限 |
|-----------|------|-------------|----------------|
| avatars | プロフィール画像 | 公開（低解像度） | 300秒 |
| content | 購読コンテンツ | 購読者のみ | 60秒 |
| receipts | レシート類 | 運営のみ | 60秒 |
| temp | アップロード中 | アップローダー | 3600秒 |

### 運用ルール
- **署名URL**: 全バケットで必須（直接アクセス禁止）
- **有効期限**: 用途に応じた適切な期間設定
- **アクセス制御**: RLSポリシーで厳格な権限管理
- **監査**: 全アクセス操作をログ記録

## 🔐 監査ログ運用

### audit_ingest テーブル運用
```sql
CREATE TABLE audit_ingest (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id),
  source_type text NOT NULL, -- 'receipt', 'screenshot', 'youtube'
  action text NOT NULL,      -- 'upload', 'process', 'access', 'delete'
  details jsonb,             -- 処理結果、メタデータ
  ip_address inet,
  user_agent text,
  created_at timestamptz DEFAULT now()
);
```

### 必須記録操作
- **アップロード**: ファイル受付時の初期記録
- **処理開始**: OCR/解析処理開始時
- **PII検出**: マスキング適用時の詳細記録
- **アクセス**: 署名URL発行時の記録
- **削除**: ファイル削除時の記録

### 保存期間
- **運用ログ**: 90日保持
- **PII検出ログ**: 1年保持（法務確認用）
- **アクセスログ**: 180日保持（セキュリティ監査用）

## 🛡️ PIIマスキング基準

### 検出対象パターン
```regex
# メールアドレス
/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i

# 電話番号（日本）
/0\d{1,4}-\d{1,4}-\d{4}/

# 郵便番号
/〒?\d{3}-\d{4}/

# 住所（基本パターン）
/[東京都|大阪府|...][^0-9]*/
```

### 置換ルール
- **メール**: `<PII:EMAIL>`
- **電話**: `<PII:TEL>`
- **住所**: `<PII:ADDR>`
- **その他PII**: `<PII:OTHER>`

### 例外処理
- **除外対象**: 商品名、ブランド名、SNSハンドル
- **誤検出対策**: ホワイトリストによる除外
- **手動確認**: 疑わしい検出結果の手動レビュー

## 🔍 品質監視

### メトリクス収集
- **アップロード成功率**: 99.5%以上目標
- **PII検出率**: 95%以上目標
- **署名URL有効期限遵守**: 100%
- **ストレージ使用量**: 警告80%、上限90%

### アラート設定
- **PII検出率低下**: <90% で警告
- **ストレージ使用量**: >80% で警告
- **署名URL期限切れ**: 検知時に即時対応
- **異常アクセス**: 不審なパターン検知

## 🚀 パフォーマンス最適化

### キャッシュ戦略
- **CDN活用**: Cloudflare連携で高速配信
- **ブラウザキャッシュ**: 適切なCache-Control設定
- **メモリキャッシュ**: 頻繁アクセスファイルのメモリ保持

### 処理効率化
- **並行処理**: 複数ファイルの一括処理
- **キュー管理**: 優先度ベースの処理順序
- **リソース制限**: CPU/メモリ使用量の制御

## 🔒 セキュリティ対策

### データ保護
- **転送中**: HTTPS/TLS 1.3必須
- **保存中**: Supabase暗号化適用
- **アクセス**: 署名URL + RLSの二重制御

### プライバシー保護
- **最小データ**: 必要な情報のみ収集・保存
- **即時削除**: 処理完了後の元画像削除
- **匿名化**: 不要な個人情報の除去

## 📋 運用チェックリスト

### 日次確認
- [ ] ストレージ使用量の監視
- [ ] PII検出率の確認
- [ ] アップロード成功率の検証
- [ ] エラーログの確認

### 週次確認
- [ ] 監査ログの完全性確認
- [ ] 署名URL設定の妥当性検証
- [ ] バックアップ状況の確認

### 月次確認
- [ ] パフォーマンスメトリクスの傾向分析
- [ ] セキュリティログの監査
- [ ] 運用ルールの見直し

## 🆘 トラブルシューティング

### 一般的な問題
- **アップロード失敗**: APIキー・権限設定の確認
- **署名URL無効**: 有効期限・スコープ設定の確認
- **PII検出漏れ**: 正規表現パターンの更新
- **パフォーマンス低下**: リソース割り当ての見直し

### 緊急対応
- **データ漏洩疑い**: 即時アクセス遮断＋調査
- **サービス停止**: バックアップからの復旧
- **大量アクセス**: レート制限の適用

## 📈 改善計画

### 短期改善（1ヶ月）
- パフォーマンス監視ダッシュボード構築
- PII検出精度の改善
- 運用自動化スクリプト開発

### 中期改善（3ヶ月）
- AIによる自動PII検出強化
- リアルタイム監視システム導入
- マルチリージョン対応

### 長期改善（6ヶ月）
- サーバーレスアーキテクチャ移行
- 機械学習によるコンテンツ分類
- エッジコンピューティング活用

---

*このガイドはDay3データ取り込み仕様完了に伴い更新してください*
