name: Claude Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  claude-response:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '@claude') || github.event_name == 'issues'
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Claude Code Assistant
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const https = require('https');
            
            // Claude APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
            async function callClaude(prompt) {
              const data = JSON.stringify({
                model: "claude-3-5-sonnet-20241022",
                max_tokens: 4000,
                messages: [{
                  role: "user",
                  content: prompt
                }]
              });
              
              const options = {
                hostname: 'api.anthropic.com',
                port: 443,
                path: '/v1/messages',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': '${{ secrets.CLAUDE_API_KEY }}',
                  'anthropic-version': '2023-06-01',
                  'Content-Length': data.length
                }
              };
              
              return new Promise((resolve, reject) => {
                const req = https.request(options, (res) => {
                  let responseData = '';
                  res.on('data', (chunk) => {
                    responseData += chunk;
                  });
                  res.on('end', () => {
                    try {
                      const parsed = JSON.parse(responseData);
                      resolve(parsed);
                    } catch (e) {
                      reject(e);
                    }
                  });
                });
                
                req.on('error', (e) => {
                  reject(e);
                });
                
                req.write(data);
                req.end();
              });
            }
            
            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
            let contextInfo = '';
            let prompt = '';
            
            if (context.eventName === 'issue_comment') {
              const comment = context.payload.comment.body;
              const issue = context.payload.issue;
              
              contextInfo = `
              Issue: ${issue.title}
              Issue Body: ${issue.body}
              Comment: ${comment}
              Repository: ${context.repo.owner}/${context.repo.repo}
              `;
              
              prompt = `ã‚ãªãŸã¯Starlistã‚¢ãƒ—ãƒªï¼ˆFlutter/Dartï¼‰ã®é–‹ç™ºã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®GitHub Issueã¨ã‚³ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦Flutter/Dartã®å°‚é–€çŸ¥è­˜ã‚’æ´»ç”¨ã—ã¦å›ç­”ã—ã¦ãã ã•ã„ï¼š

              ${contextInfo}
              
              å›ç­”ã¯æ—¥æœ¬èªã§ã€å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚„Flutterãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚`;
              
            } else if (context.eventName === 'issues') {
              const issue = context.payload.issue;
              
              contextInfo = `
              New Issue: ${issue.title}
              Issue Body: ${issue.body}
              Repository: ${context.repo.owner}/${context.repo.repo}
              `;
              
              prompt = `ã‚ãªãŸã¯Starlistã‚¢ãƒ—ãƒªï¼ˆFlutter/Dartï¼‰ã®é–‹ç™ºã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æ–°ã—ã„IssueãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚Flutter/Dartã®å°‚é–€çŸ¥è­˜ã‚’æ´»ç”¨ã—ã¦åˆ†æã¨ææ¡ˆã‚’ã—ã¦ãã ã•ã„ï¼š

              ${contextInfo}
              
              ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã—ã¦ãã ã•ã„ï¼š
              1. æŠ€è¡“çš„ãªå®Ÿè£…æ–¹æ³•
              2. å¿…è¦ãªä¾å­˜é–¢ä¿‚
              3. è€ƒæ…®ã™ã¹ããƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
              4. æ½œåœ¨çš„ãªèª²é¡Œã¨è§£æ±ºç­–
              
              å›ç­”ã¯æ—¥æœ¬èªã§ã€å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚`;
            }
            
            try {
              console.log('Calling Claude API...');
              const response = await callClaude(prompt);
              
              if (response.content && response.content[0] && response.content[0].text) {
                const claudeResponse = response.content[0].text;
                
                // GitHub Issueã¾ãŸã¯PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
                if (context.eventName === 'issue_comment') {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.issue.number,
                    body: `ğŸ¤– **Claude Assistant**\n\n${claudeResponse}`
                  });
                } else if (context.eventName === 'issues') {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.issue.number,
                    body: `ğŸ¤– **Claude Assistant - Issue Analysis**\n\n${claudeResponse}`
                  });
                }
                
                console.log('Claude response posted successfully');
              } else {
                console.error('Invalid response from Claude API:', response);
              }
              
            } catch (error) {
              console.error('Error calling Claude API:', error);
              
              // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
              const errorMessage = `ğŸš¨ **Claude Assistant Error**\n\nSorry, I encountered an error while processing your request. Please try again later.\n\nError: ${error.message}`;
              
              if (context.eventName === 'issue_comment') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  body: errorMessage
                });
              } else if (context.eventName === 'issues') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  body: errorMessage
                });
              }
            } 