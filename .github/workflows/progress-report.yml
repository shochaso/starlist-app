name: Progress Report

on:
  pull_request:
    branches: [ develop, main, release/** ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ develop, main ]
  schedule:
    # æ¯æœ 09:00 JST = 00:00 UTC
    - cron: "0 0 * * *"

permissions:
  contents: read
  pull-requests: write

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure ripgrep is available
        run: |
          if ! command -v rg >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y ripgrep
          fi
      - uses: actions/checkout@v4

      - name: Collect repo stats
        run: |
          mkdir -p .report
          echo "# é–‹ç™ºé€²æ—ãƒ¬ãƒãƒ¼ãƒˆï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰" > .report/report.md
          echo "" >> .report/report.md

          echo "## ğŸ“¦ ãƒ–ãƒ©ãƒ³ãƒ / ã‚³ãƒŸãƒƒãƒˆ" >> .report/report.md
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: \`$(git rev-parse --abbrev-ref HEAD)\`" >> .report/report.md
          echo "- æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ: \`$(git log -1 --pretty=%h)\` $(git log -1 --pretty=%s)" >> .report/report.md
          echo "- ç›´è¿‘å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°(éå»24h): $(git log --since='24 hours ago' --name-only --pretty='' | sort -u | wc -l)" >> .report/report.md
          echo "" >> .report/report.md

          echo "## ğŸ§© ä¸»ãªå¤‰æ›´é ˜åŸŸ" >> .report/report.md
          echo "- Supabase / Edge Functions: $(git diff --name-only HEAD~1..HEAD | grep -E '^supabase/functions' | wc -l) files" >> .report/report.md
          echo "- Flutter / Web: $(git diff --name-only HEAD~1..HEAD | grep -E '(^lib/|^web/|^src/)' | wc -l) files" >> .report/report.md
          echo "- CI/CD: $(git diff --name-only HEAD~1..HEAD | grep -E '^.github/workflows' | wc -l) files" >> .report/report.md
          echo "" >> .report/report.md

          echo "## âš™ï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆè‡ªå‹•ãƒ’ãƒ³ãƒˆï¼‰" >> .report/report.md
          echo "| é …ç›® | çŠ¶æ³ | æ ¹æ‹  |" >> .report/report.md
          echo "|---|---|---|" >> .report/report.md
          test -f supabase/functions/exchange/index.ts && echo "| exchangeé–¢æ•°(Line Authäº¤æ›) | âœ… | ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ |" >> .report/report.md || echo "| exchangeé–¢æ•°(Line Authäº¤æ›) | â³ | ãƒ•ã‚¡ã‚¤ãƒ«æœªæ¤œå‡º |" >> .report/report.md
          rg -n "Deno\.serve\(|Response\(" supabase/functions/exchange/index.ts 2>/dev/null && echo "| CORS/é€”ä¸­åˆ‡æ–­å¯¾ç­– | âœ… | CORS/Responseæ¤œå‡º |" >> .report/report.md || echo "| CORS/é€”ä¸­åˆ‡æ–­å¯¾ç­– | â³ | æœªæ¤œå‡º |" >> .report/report.md
          command -v supabase >/dev/null && echo "| Supabase CLI | âœ… | CLIæ¤œå‡º |" >> .report/report.md || echo "| Supabase CLI | â³ | æœªæ¤œå‡º |" >> .report/report.md
          test -f .github/workflows/supabase.yml && echo "| Supabaseãƒ‡ãƒ—ãƒ­ã‚¤CI | âœ… | supabase.ymlæ¤œå‡º |" >> .report/report.md || echo "| Supabaseãƒ‡ãƒ—ãƒ­ã‚¤CI | â³ | ãªã— |" >> .report/report.md
          echo "" >> .report/report.md

          echo "## ğŸš¨ TODO / FIXMEï¼ˆæŠœç²‹ï¼‰" >> .report/report.md
          (rg -n 'TODO|FIXME|NOTE:' -S --max-filesize 200K --glob '!**/dist/**' --glob '!**/build/**' | head -n 30) \
            || echo "ï¼ˆè©²å½“ãªã—ï¼‰" >> .report/report.md
          echo "" >> .report/report.md

          echo "## ğŸ’¬ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ" >> .report/report.md
          echo "1. exchange ã® JWT æœŸé™çŸ­ç¸® & 401æ™‚ã®è‡ªå‹•å†äº¤æ›" >> .report/report.md
          echo "2. RLS ãƒãƒªã‚·ãƒ¼ã®E2Eãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ï¼ˆè‡ªåˆ†ä»¥å¤–ã®ãƒ‡ãƒ¼ã‚¿ãŒèª­ã‚ãªã„ã“ã¨ï¼‰" >> .report/report.md
          echo "3. release/* â†’ STGã€è‡ªå‹•â†’mainã®æœ¬ç•ªãƒ©ã‚¤ãƒ³ã‚’1å›é€šã—ã¦æ¤œè¨¼" >> .report/report.md

      - name: Summarize Flutter analyze/test
        run: |
          mkdir -p .report
          (flutter analyze || true) | tee .report/analyze.txt
          echo "" >> .report/report.md
          echo "## ğŸ§ª é™çš„è§£æ/ãƒ†ã‚¹ãƒˆ è¦ç´„" >> .report/report.md
          echo "- analyze: $(grep -Eo '[0-9]+ (issues|warnings|info|infos)?' .report/analyze.txt | head -n1 || echo 'çµæœè¦ç¢ºèª')" >> .report/report.md
          (flutter test --reporter=compact || true) | tee .report/test.txt
          echo "- test: $(grep -Eo '[0-9]+ passed, [0-9]+ failed' .report/test.txt | tail -n1 || echo 'çµæœè¦ç¢ºèª')" >> .report/report.md

      - name: Build Flutter bundle (assets only)
        run: flutter build bundle --release

      - name: Ensure legacy convenience icons removed
        run: dart scripts/check_service_icon_manifest.dart build/flutter_assets/AssetManifest.json

      - name: Build Flutter web bundle (no service worker)
        run: flutter build web --release --pwa-strategy=none

      - name: List Supabase functions (optional)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_STG }}
        run: |
          if command -v supabase >/dev/null 2>&1; then
            supabase link --project-ref zjwvmoxpacbpwawlwbrd
            echo "" >> .report/report.md
            echo "## ğŸ§± Supabase Functions" >> .report/report.md
            supabase functions list >> .report/report.md || true
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: progress-report
          path: .report/report.md
          retention-days: 14

      - name: Comment to PR (if PR)
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            <details><summary>ğŸ“ è‡ªå‹•é€²æ—ãƒ¬ãƒãƒ¼ãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>
            
            $(cat .report/report.md)
            
            </details>
