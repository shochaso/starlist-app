name: Supabase Deploy

on:
  pull_request:
    branches: [ develop, release/** ]
  push:
    branches: [ release/**, main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Supabase CLI
        run: |
          curl -fsSL https://cli.supabase.com/install | sh
          echo "$HOME/.supabase/bin" >> $GITHUB_PATH
      - name: Dry-run migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_STG }}
        run: |
          supabase link --project-ref zjwvmoxpacbpwawlwbrd
          supabase db push --dry-run

  deploy-stg:
    if: startsWith(github.ref, 'refs/heads/release/')
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Supabase CLI
        run: |
          curl -fsSL https://cli.supabase.com/install | sh
          echo "$HOME/.supabase/bin" >> $GITHUB_PATH
      - name: Deploy (STG)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_STG }}
        run: |
          supabase link --project-ref zjwvmoxpacbpwawlwbrd
          supabase db push
          supabase functions deploy

  deploy-prod:
    if: github.ref == 'refs/heads/main'
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Supabase CLI
        run: |
          curl -fsSL https://cli.supabase.com/install | sh
          echo "$HOME/.supabase/bin" >> $GITHUB_PATH
      - name: Deploy (PROD)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PROD }}
        run: |
          supabase link --project-ref zjwvmoxpacbpwawlwbrd
          supabase db push
          supabase functions deploy
