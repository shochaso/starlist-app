name: Slack Notification with Debounce

on:
  # pull_request ã®è‡ªå‹•å®Ÿè¡Œã‚’å¤–ã—ã€PRã‚²ãƒ¼ãƒˆã‹ã‚‰åˆ‡ã‚Šé›¢ã™
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  workflow_dispatch: {}  # æ‰‹å‹•ãƒ†ã‚¹ãƒˆç”¨

# 60ç§’ãƒ‡ãƒã‚¦ãƒ³ã‚¹: åŒä¸€PRã¸ã®é€£ç¶šæ›´æ–°ã¯æœ€å¾Œã®1å›ã®ã¿é€šçŸ¥
concurrency:
  group: pr-${{ github.event.pull_request.number || github.event.issue.number }}-notify
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  issues: read

jobs:
  notify:
    runs-on: ubuntu-latest
    # Draft PRã¯é€šçŸ¥ã—ãªã„ï¼ˆworkflow_dispatchã¯å¸¸ã«å®Ÿè¡Œï¼‰
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.draft != true) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request) ||
      github.event_name == 'pull_request_review_comment'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å·®åˆ†å–å¾—ã®ãŸã‚å…¨å±¥æ­´ã‚’å–å¾—

      - name: Wait for debounce
        run: sleep 60

      - name: Get PR information
        id: pr_info
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            PR_HEAD="${{ github.event.pull_request.head.ref }}"
            PR_BASE="${{ github.event.pull_request.base.ref }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_BODY="${{ github.event.pull_request.body }}"
          else
            PR_NUMBER=${{ github.event.issue.number }}
            PR_TITLE="${{ github.event.issue.title }}"
            PR_AUTHOR="${{ github.event.comment.user.login }}"
            PR_URL="${{ github.event.issue.html_url }}"
            PR_BODY="${{ github.event.comment.body }}"
            PR_HEAD="N/A"
            PR_BASE="N/A"
          fi
          
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "head=$PR_HEAD" >> $GITHUB_OUTPUT
          echo "base=$PR_BASE" >> $GITHUB_OUTPUT
          echo "url=$PR_URL" >> $GITHUB_OUTPUT
          
          # PRæœ¬æ–‡ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆæ”¹è¡Œå¯¾å¿œï¼‰
          echo "$PR_BODY" > /tmp/pr_body.txt

      - name: Get PR labels
        id: labels
        continue-on-error: true
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ] || [ "${{ github.event_name }}" = "issue_comment" ]; then
            LABELS=$(gh pr view ${{ steps.pr_info.outputs.number }} --json labels --jq '.labels | map(.name) | join(", ")' 2>/dev/null || echo "")
          else
            LABELS=""
          fi
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR stats
        id: stats
        continue-on-error: true
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            FILES_CHANGED=$(gh pr view ${{ steps.pr_info.outputs.number }} --json files --jq '.files | length' 2>/dev/null || echo "0")
            ADDITIONS=$(gh pr view ${{ steps.pr_info.outputs.number }} --json additions --jq '.additions' 2>/dev/null || echo "0")
            DELETIONS=$(gh pr view ${{ steps.pr_info.outputs.number }} --json deletions --jq '.deletions' 2>/dev/null || echo "0")
            
            echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
            echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
            echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          else
            echo "files_changed=0" >> $GITHUB_OUTPUT
            echo "additions=0" >> $GITHUB_OUTPUT
            echo "deletions=0" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract main diff
        id: diff
        continue-on-error: true
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ steps.pr_info.outputs.base }}" != "N/A" ]; then
            # å·®åˆ†ã‚’å–å¾—ï¼ˆæœ€å¤§3ãƒ•ã‚¡ã‚¤ãƒ«ã€200è¡Œä»¥å†…ï¼‰
            git diff origin/${{ steps.pr_info.outputs.base }}...${{ steps.pr_info.outputs.head }} > /tmp/full_diff.txt 2>/dev/null || echo "" > /tmp/full_diff.txt
            
            # ãƒ•ã‚¡ã‚¤ãƒ«å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆ
            # 1. /docs/** (ä»•æ§˜)
            # 2. /lib/src/** (ã‚³ã‚¢)
            # 3. /lib/features/** (æ©Ÿèƒ½)
            # 4. /lib/screens/** (UI)
            # 5. ãã®ä»–
            
            DIFF_FILES=$(git diff --name-only origin/${{ steps.pr_info.outputs.base }}...${{ steps.pr_info.outputs.head }} 2>/dev/null | \
              grep -E '\.(dart|md|yaml|yml)$' | \
              sort -t/ -k1,1 -k2,2 | \
              head -n 3 || echo "")
            
            DIFF_CONTENT=""
            TOTAL_LINES=0
            FILE_COUNT=0
            
            for file in $DIFF_FILES; do
              if [ $TOTAL_LINES -ge 200 ]; then
                break
              fi
              
              FILE_DIFF=$(git diff origin/${{ steps.pr_info.outputs.base }}...${{ steps.pr_info.outputs.head }} -- "$file" 2>/dev/null | head -n 70 || echo "")
              FILE_LINES=$(echo "$FILE_DIFF" | wc -l)
              
              if [ $((TOTAL_LINES + FILE_LINES)) -le 200 ]; then
                DIFF_CONTENT="$DIFF_CONTENT\n\n### $file\n\`\`\`diff\n$FILE_DIFF\n\`\`\`"
                TOTAL_LINES=$((TOTAL_LINES + FILE_LINES))
                FILE_COUNT=$((FILE_COUNT + 1))
              fi
            done
            
            # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒã‚¹ã‚¯
            DIFF_CONTENT=$(echo "$DIFF_CONTENT" | sed -E 's/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/***@***.***/g')
            DIFF_CONTENT=$(echo "$DIFF_CONTENT" | sed -E 's/.*(token|key|secret|password|api_key).*\=.*/[MASKED]/gi')
            
            # å·®åˆ†ãŒå¤§ãã„å ´åˆã¯ArtifactåŒ–
            if [ -f /tmp/full_diff.txt ] && [ $(cat /tmp/full_diff.txt | wc -l) -gt 200 ]; then
              echo "large_diff=true" >> $GITHUB_OUTPUT
              cp /tmp/full_diff.txt /tmp/pr-diff-${{ steps.pr_info.outputs.number }}.txt
            else
              echo "large_diff=false" >> $GITHUB_OUTPUT
            fi
            
            # å·®åˆ†ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            echo -e "$DIFF_CONTENT" > /tmp/diff_content.txt
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          else
            echo "large_diff=false" >> $GITHUB_OUTPUT
            echo "file_count=0" >> $GITHUB_OUTPUT
            echo "ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ã®ãŸã‚å·®åˆ†ãªã—" > /tmp/diff_content.txt
          fi

      - name: Upload large diff as artifact
        if: steps.diff.outputs.large_diff == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-diff-${{ steps.pr_info.outputs.number }}
          path: /tmp/pr-diff-${{ steps.pr_info.outputs.number }}.txt
          retention-days: 30

      - name: Determine webhook URL
        id: webhook
        run: |
          LABELS="${{ steps.labels.outputs.labels }}"
          WEBHOOK_URL=""
          
          # ãƒ©ãƒ™ãƒ«åˆ¥ã«WebhookæŒ¯ã‚Šåˆ†ã‘
          if echo "$LABELS" | grep -q "area:spec" && [ -n "$SLACK_WEBHOOK_SPEC" ]; then
            WEBHOOK_URL="$SLACK_WEBHOOK_SPEC"
          elif echo "$LABELS" | grep -q "area:ui" && [ -n "$SLACK_WEBHOOK_UI" ]; then
            WEBHOOK_URL="$SLACK_WEBHOOK_UI"
          elif echo "$LABELS" | grep -q "area:api" && [ -n "$SLACK_WEBHOOK_API" ]; then
            WEBHOOK_URL="$SLACK_WEBHOOK_API"
          elif [ -n "$SLACK_WEBHOOK_DEFAULT" ]; then
            WEBHOOK_URL="$SLACK_WEBHOOK_DEFAULT"
          fi
          
          echo "url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
        env:
          SLACK_WEBHOOK_DEFAULT: ${{ secrets.SLACK_WEBHOOK_DEFAULT }}
          SLACK_WEBHOOK_SPEC: ${{ secrets.SLACK_WEBHOOK_SPEC }}
          SLACK_WEBHOOK_UI: ${{ secrets.SLACK_WEBHOOK_UI }}
          SLACK_WEBHOOK_API: ${{ secrets.SLACK_WEBHOOK_API }}

      - name: Build Slack message
        id: message
        run: |
          EVENT_TYPE="${{ github.event_name }}"
          LABELS="${{ steps.labels.outputs.labels }}"
          
          # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³
          if [ "$EVENT_TYPE" = "pull_request" ]; then
            ICON="ğŸ””"
            TITLE="PR #${{ steps.pr_info.outputs.number }}: ${{ steps.pr_info.outputs.title }}"
          else
            ICON="ğŸ’¬"
            TITLE="æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆ on PR #${{ steps.pr_info.outputs.number }}"
          fi
          
          # ãƒ©ãƒ™ãƒ«ã«å¿œã˜ãŸè¿½åŠ æƒ…å ±
          EXTRA_INFO=""
          if echo "$LABELS" | grep -q "area:spec"; then
            EXTRA_INFO="\n\nâš ï¸ **ä»•æ§˜å¤‰æ›´**: æ—¢å­˜å®Ÿè£…ã¨ã®æ•´åˆæ€§ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          elif echo "$LABELS" | grep -q "area:ui"; then
            EXTRA_INFO="\n\nğŸ¨ **UIå¤‰æ›´**: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã¨ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          elif echo "$LABELS" | grep -q "area:api"; then
            EXTRA_INFO="\n\nğŸ”Œ **APIå¤‰æ›´**: ç ´å£Šçš„å¤‰æ›´ãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„"
          fi
          
          # åŸºæœ¬æƒ…å ±
          MESSAGE="$ICON **$TITLE**\n\n"
          MESSAGE="${MESSAGE}ğŸ‘¤ **ä½œæˆè€…**: ${{ steps.pr_info.outputs.author }}\n"
          
          if [ "$EVENT_TYPE" = "pull_request" ]; then
            MESSAGE="${MESSAGE}ğŸŒ¿ **ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ steps.pr_info.outputs.head }}\` â†’ \`${{ steps.pr_info.outputs.base }}\`\n"
            MESSAGE="${MESSAGE}ğŸ·ï¸ **ãƒ©ãƒ™ãƒ«**: $LABELS\n\n"
            MESSAGE="${MESSAGE}ğŸ“Š **å¤‰æ›´ã‚µãƒãƒªãƒ¼**\n"
            MESSAGE="${MESSAGE}- ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.stats.outputs.files_changed }}\n"
            MESSAGE="${MESSAGE}- è¿½åŠ : +${{ steps.stats.outputs.additions }} è¡Œ\n"
            MESSAGE="${MESSAGE}- å‰Šé™¤: -${{ steps.stats.outputs.deletions }} è¡Œ\n"
          fi
          
          MESSAGE="${MESSAGE}$EXTRA_INFO\n\n"
          
          # å·®åˆ†æƒ…å ±
          if [ "$EVENT_TYPE" = "pull_request" ]; then
            if [ "${{ steps.diff.outputs.large_diff }}" = "true" ]; then
              MESSAGE="${MESSAGE}ğŸ“¦ **å·®åˆ†ãŒå¤§ãã„ãŸã‚Artifactã«ä¿å­˜ã—ã¾ã—ãŸ**\n\n"
              MESSAGE="${MESSAGE}ğŸ”— [GitHub Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n"
              MESSAGE="${MESSAGE}â†’ Artifacts ã‚¿ãƒ–ã‹ã‚‰ \`pr-diff-${{ steps.pr_info.outputs.number }}.txt\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\n\n"
              MESSAGE="${MESSAGE}ğŸ’¡ **Cursor ã§ã®ä½¿ã„æ–¹**:\n"
              MESSAGE="${MESSAGE}1. Artifactã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\n"
              MESSAGE="${MESSAGE}2. Cursorã§é–‹ã\n"
              MESSAGE="${MESSAGE}3. å…¨é¸æŠã—ã¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ \n"
            else
              MESSAGE="${MESSAGE}ğŸ“ **ä¸»è¦å·®åˆ†** (æœ€å¤§3ãƒ•ã‚¡ã‚¤ãƒ«ã€200è¡Œä»¥å†…)\n"
              MESSAGE="${MESSAGE}$(cat /tmp/diff_content.txt)\n\n"
              MESSAGE="${MESSAGE}---\n\n"
              MESSAGE="${MESSAGE}ğŸ“‹ **Cursorè²¼ã‚Šä»˜ã‘ç”¨**\n"
              MESSAGE="${MESSAGE}ä¸Šè¨˜ã®å·®åˆ†ã‚’Cursorã®ãƒãƒ£ãƒƒãƒˆã«ã‚³ãƒ”ãƒ¼ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æŒ‡ç¤ºã—ã¦ãã ã•ã„:\n\n"
              MESSAGE="${MESSAGE}\`\`\`\n"
              MESSAGE="${MESSAGE}@codebase ã“ã®å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„\n"
              MESSAGE="${MESSAGE}\`\`\`\n"
            fi
          else
            MESSAGE="${MESSAGE}ğŸ“ **ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹**:\n"
            MESSAGE="${MESSAGE}$(cat /tmp/pr_body.txt)\n\n"
            MESSAGE="${MESSAGE}ğŸ”— [ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹](${{ steps.pr_info.outputs.url }})\n"
          fi
          
          MESSAGE="${MESSAGE}\n\nğŸ”— [PRã‚’è¦‹ã‚‹](${{ steps.pr_info.outputs.url }})"
          
          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo -e "$MESSAGE" > /tmp/slack_message.txt

      - name: Send to Slack
        if: steps.webhook.outputs.url != ''
        continue-on-error: true
        run: |
          MESSAGE=$(cat /tmp/slack_message.txt | jq -Rs .)
          
          curl -fsS -X POST "${{ steps.webhook.outputs.url }}" \
            -H "Content-Type: application/json" \
            -d "{\"text\": $MESSAGE}" \
          || echo "::warning::Slack post failed (non-blocking)"

      - name: Notify on failure
        if: failure() && secrets.SLACK_WEBHOOK_DEFAULT != ''
        continue-on-error: true
        run: |
          curl -fsS -X POST "${{ secrets.SLACK_WEBHOOK_DEFAULT }}" \
            -H "Content-Type: application/json" \
            -d "{\"text\": \"âŒ **è‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—**\n\nğŸ”§ **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${{ github.workflow }}\nğŸ“ **ã‚¨ãƒ©ãƒ¼**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸ\n\nğŸ”— [ãƒ­ã‚°ã‚’ç¢ºèª](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\nğŸ’¡ **å¯¾å‡¦æ–¹æ³•**:\n1. GitHub Actions ã®ãƒ­ã‚°ã‚’ç¢ºèª\n2. Secrets ã®è¨­å®šã‚’ç¢ºèª\n3. å¿…è¦ã«å¿œã˜ã¦å†å®Ÿè¡Œ\"}" \
          || echo "::warning::Failure notification to Slack failed (non-blocking)"
      
      - name: Workflow completion
        run: |
          echo "âœ… Notification workflow completed successfully"
          echo "Event: ${{ github.event_name }}"
          echo "Webhook configured: ${{ steps.webhook.outputs.url != '' }}"
