# SLSA Provenance workflow (Phase 2.1: Hardened with per-job permissions, atomic manifest, run_id in artifact)

name: slsa-provenance

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v2025.11.12)"
        required: false
  release:
    types: [published]

# Workflow-level permissions (minimal)
permissions:
  contents: read
  id-token: write
  attestations: write
  actions: read

concurrency:
  group: provenance-manifest-${{ github.ref }}
  cancel-in-progress: true

jobs:
  provenance:
    # pushで誤起動した場合は即スキップ
    if: github.event_name != 'push'
    runs-on: ubuntu-latest
    # Per-job permissions (minimal)
    permissions:
      contents: read
      id-token: write
      attestations: write
      actions: read
    outputs:
      run_id: ${{ github.run_id }}
      tag: ${{ steps.resolve_tag.outputs.tag }}
      sha256: ${{ steps.calculate_sha256.outputs.sha256 }}
      status: ${{ job.status }}
      artifact_url: ${{ steps.upload_artifact.outputs.artifact-url }}
    steps:
      - name: Checkout (shallow ok)
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug context
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "event_action=${{ github.event.action }}"
          echo "release_tag=${{ github.event.release.tag_name }}"
          echo "inputs_tag=${{ inputs.tag }}"

      - name: Resolve TAG
        id: resolve_tag
        shell: bash
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [ -z "$TAG" ] && [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          fi
          if [ -z "$TAG" ]; then
            git fetch --tags --force --quiet
            TAG="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          fi
          echo "TAG=$TAG"
          if [ -z "$TAG" ]; then
            echo "No tag found. Intentionally skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Conditional skip
        if: steps.resolve_tag.outputs.skip == 'true'
        run: echo "SKIP: no tag context (push or tag not found)."

      - name: Generate provenance
        if: steps.resolve_tag.outputs.skip != 'true'
        id: generate_provenance
        run: |
          TAG="${{ steps.resolve_tag.outputs.tag }}"
          RUN_ID="${{ github.run_id }}"
          echo "Generating provenance for $TAG (run_id: $RUN_ID)"
          PROVENANCE_DIR="artifacts/slsa/${TAG}/${RUN_ID}"
          mkdir -p "$PROVENANCE_DIR"
          cat <<EOF > "$PROVENANCE_DIR/provenance-${TAG}-${RUN_ID}.json"
{
  "predicateType": "https://slsa.dev/provenance/v0.2",
  "builder": { "id": "github-actions/slsa-provenance" },
  "buildType": "https://github.com/${{ github.repository }}/actions/workflows/slsa-provenance.yml",
  "invocation": {
    "environment": "github",
    "workflow": "${{ github.workflow }}",
    "run_id": "${{ github.run_id }}",
    "release": "$TAG"
  },
  "metadata": {
    "buildInvocationId": "${{ github.run_id }}",
    "completeness": {
      "parameters": true,
      "environment": false,
      "materials": false
    }
  }
}
EOF
          echo "Provenance size:"
          wc -c "$PROVENANCE_DIR/provenance-${TAG}-${RUN_ID}.json" || true
          echo "Provenance content:"
          cat "$PROVENANCE_DIR/provenance-${TAG}-${RUN_ID}.json"
          echo "provenance_path=$PROVENANCE_DIR/provenance-${TAG}-${RUN_ID}.json" >> $GITHUB_OUTPUT

      - name: Calculate SHA256
        if: steps.resolve_tag.outputs.skip != 'true'
        id: calculate_sha256
        run: |
          PROVENANCE_FILE="${{ steps.generate_provenance.outputs.provenance_path }}"
          SHA256=$(sha256sum "$PROVENANCE_FILE" | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Upload artifact (with run_id in path)
        if: steps.resolve_tag.outputs.skip != 'true'
        id: upload_artifact
        uses: actions/upload-artifact@v4
        with:
          name: "provenance-${{ steps.resolve_tag.outputs.tag }}-${{ github.run_id }}"
          path: "artifacts/slsa/${{ steps.resolve_tag.outputs.tag }}/${{ github.run_id }}/provenance-${{ steps.resolve_tag.outputs.tag }}-${{ github.run_id }}.json"
          retention-days: 365
        continue-on-error: true

      - name: Atomic manifest write
        if: steps.resolve_tag.outputs.skip != 'true'
        id: manifest
        run: |
          TAG="${{ steps.resolve_tag.outputs.tag }}"
          RUN_ID="${{ github.run_id }}"
          SHA256="${{ steps.calculate_sha256.outputs.sha256 }}"
          DATE=$(date -u +"%Y-%m-%d")
          MANIFEST_DIR="docs/reports/${DATE}"
          mkdir -p "$MANIFEST_DIR"
          
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${RUN_ID}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${TAG}"
          
          # Atomic write: write to temp file first, then atomic move
          MANIFEST_FILE="${MANIFEST_DIR}/manifest.json"
          TEMP_FILE="${MANIFEST_FILE}.tmp.${RUN_ID}"
          
          MANIFEST_ENTRY=$(cat <<EOF
{
  "run_id": ${RUN_ID},
  "tag": "${TAG}",
  "sha": "${SHA256}",
  "artifact_url": "${ARTIFACT_URL}",
  "actor": "${{ github.actor }}",
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "status": "${{ job.status }}",
  "governance_flag": "provenance-ready",
  "release_url": "${RELEASE_URL}"
}
EOF
)
          
          # Atomic append: read existing, merge, write atomically
          if [ -f "$MANIFEST_FILE" ]; then
            # Update existing entry or append
            jq --argjson entry "$MANIFEST_ENTRY" '. | map(if .run_id == $entry.run_id then $entry else . end) | if any(.run_id == $entry.run_id) then . else . + [$entry] end | sort_by(.run_id)' "$MANIFEST_FILE" > "$TEMP_FILE"
          else
            echo "[$MANIFEST_ENTRY]" > "$TEMP_FILE"
          fi
          
          # Atomic move
          mv "$TEMP_FILE" "$MANIFEST_FILE"
          
          echo "manifest_path=$MANIFEST_FILE" >> $GITHUB_OUTPUT
          echo "Manifest entry created atomically: $MANIFEST_FILE"

      - name: Commit manifest (separate job for write permissions)
        if: steps.resolve_tag.outputs.skip != 'true' && steps.manifest.outputs.manifest_path != ''
        run: |
          git config user.name "STARLIST CI"
          git config user.email "ops@starlist.jp"
          git add "${{ steps.manifest.outputs.manifest_path }}"
          git commit -m "chore(ops): add SLSA provenance manifest entry for ${{ steps.resolve_tag.outputs.tag }} (run_id: ${{ github.run_id }})" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref }} || echo "Push failed (may be in freeze window)"

      - name: Sync to Supabase
        if: steps.resolve_tag.outputs.skip != 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          TAG="${{ steps.resolve_tag.outputs.tag }}"
          RUN_ID="${{ github.run_id }}"
          SHA256="${{ steps.calculate_sha256.outputs.sha256 }}"
          
          PAYLOAD=$(cat <<EOF
{
  "app": "starlist",
  "env": "prod",
  "event": "slsa_provenance",
  "ok": true,
  "latency_ms": null,
  "extra": {
    "run_id": ${RUN_ID},
    "tag": "${TAG}",
    "sha256": "${SHA256}",
    "status": "${{ job.status }}"
  }
}
EOF
)
          
          curl -sS --fail --show-error --retry 3 --max-time 30 \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -X POST \
            "${SUPABASE_URL}/functions/v1/telemetry" \
            -d "$PAYLOAD" || echo "Supabase sync failed (non-blocking)"

  commit-manifest:
    if: github.event_name != 'push' && needs.provenance.outputs.status != 'skipped'
    needs: provenance
    runs-on: ubuntu-latest
    # Separate job with write permissions for manifest commit
    permissions:
      contents: write
    concurrency:
      group: provenance-manifest-commit-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Commit manifest
        run: |
          MANIFEST_FILE="${{ needs.provenance.outputs.manifest_path }}"
          if [ -f "$MANIFEST_FILE" ]; then
            git config user.name "STARLIST CI"
            git config user.email "ops@starlist.jp"
            git add "$MANIFEST_FILE"
            git commit -m "chore(ops): add SLSA provenance manifest entry for ${{ needs.provenance.outputs.tag }} (run_id: ${{ needs.provenance.outputs.run_id }})" || echo "No changes to commit"
            git push origin HEAD:${{ github.ref }} || echo "Push failed (may be in freeze window)"
          fi

  notify-on-failure:
    if: failure() && github.event_name != 'push'
    needs: [provenance, commit-manifest]
    runs-on: ubuntu-latest
    concurrency:
      group: provenance-notify-${{ github.run_id }}
      cancel-in-progress: false
    # Per-job permissions for notifications
    permissions:
      contents: read
      issues: write
    steps:
      - name: Create failure issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ needs.provenance.outputs.tag }}' || 'unknown';
            const runId = '${{ github.run_id }}';
            const provenanceRunId = '${{ needs.provenance.outputs.run_id }}';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${runId}`;
            const provenanceRunUrl = `https://github.com/${{ github.repository }}/actions/runs/${provenanceRunId}`;
            
            const issueBody = `## SLSA Provenance Failure
            
            **Workflow Run ID**: ${runId}
            **Provenance Run ID**: ${provenanceRunId}
            **Tag**: ${tag}
            **Workflow**: ${{ github.workflow }}
            **Actor**: ${{ github.actor }}
            
            **Links**:
            - [Workflow Run](${runUrl})
            - [Provenance Run](${provenanceRunUrl})
            - [Release](https://github.com/${{ github.repository }}/releases/tag/${tag})
            
            **Failure Reason**: Artifact generation or manifest update failed.
            
            **Next Steps**:
            1. Check workflow logs for detailed error
            2. Verify tag exists and is valid
            3. Rerun workflow if needed
            
            Please investigate and rerun if needed.
            `;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[SLSA] Provenance failure for ${tag}`,
              body: issueBody,
              labels: ['ops-alert', 'provenance-failure', 'automated']
            });
            
            core.setOutput('issue_number', issue.data.number);
            core.setOutput('issue_url', issue.data.html_url);

      - name: Notify Slack (dual alert)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          TAG="${{ needs.provenance.outputs.tag }}"
          RUN_ID="${{ github.run_id }}"
          PROVENANCE_RUN_ID="${{ needs.provenance.outputs.run_id }}"
          ISSUE_NUMBER="${{ steps.create_issue.outputs.issue_number }}"
          ISSUE_URL="${{ steps.create_issue.outputs.issue_url }}"
          
          PAYLOAD=$(cat <<EOF
{
  "level": "error",
  "title": "SLSA Provenance Failure",
  "message": "Provenance generation failed for tag ${TAG}",
  "run_id": ${RUN_ID},
  "provenance_run_id": ${PROVENANCE_RUN_ID},
  "tag": "${TAG}",
  "issue_number": ${ISSUE_NUMBER},
  "issue_url": "${ISSUE_URL}",
  "source": "slsa-provenance",
  "action_required": true
}
EOF
)
          
          curl -sS --fail --show-error --retry 3 --max-time 30 \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Content-Type: application/json" \
            -X POST \
            "${SUPABASE_URL}/functions/v1/ops-slack-notify" \
            -d "$PAYLOAD" || echo "Slack notification failed (non-blocking)"

