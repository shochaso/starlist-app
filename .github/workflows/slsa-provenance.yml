# Debug-enabled SLSA provenance workflow

name: slsa-provenance

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v2025.11.12)"
        required: false
  release:
    types: [published]

permissions:
  contents: read
  id-token: write
  attestations: write
  actions: write

concurrency:
  group: slsa-${{ github.ref }}
  cancel-in-progress: true

jobs:
  provenance:
    # pushで誤起動した場合は即スキップ
    if: github.event_name != 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (shallow ok)
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Debug context
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "event_action=${{ github.event.action }}"
          echo "release_tag=${{ github.event.release.tag_name }}"
          echo "inputs_tag=${{ inputs.tag }}"

      - name: Resolve TAG
        id: resolve_tag
        shell: bash
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [ -z "$TAG" ] && [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          fi
          if [ -z "$TAG" ]; then
            git fetch --tags --force --quiet
            TAG="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          fi
          echo "TAG=$TAG"
          if [ -z "$TAG" ]; then
            echo "No tag found. Intentionally skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Conditional skip
        if: steps.resolve_tag.outputs.skip == 'true'
        run: echo "SKIP: no tag context (push or tag not found)."

      - name: Generate provenance
        if: steps.resolve_tag.outputs.skip != 'true'
        run: |
          TAG="${{ steps.resolve_tag.outputs.tag }}"
          echo "Generating provenance for $TAG"
          PROVENANCE_DIR="artifacts/slsa/${TAG}"
          mkdir -p "$PROVENANCE_DIR"
          cat <<EOF > "$PROVENANCE_DIR/provenance-${TAG}.json"
{
  "predicateType": "https://slsa.dev/provenance/v0.2",
  "builder": { "id": "github-actions/slsa-provenance" },
  "buildType": "https://github.com/${{ github.repository }}/actions/workflows/slsa-provenance.yml",
  "invocation": {
    "environment": "github",
    "workflow": "${{ github.workflow }}",
    "run_id": "${{ github.run_id }}",
    "release": "$TAG"
  },
  "metadata": {
    "buildInvocationId": "${{ github.run_id }}",
    "completeness": {
      "parameters": true,
      "environment": false,
      "materials": false
    }
  }
}
EOF
          echo "Provenance size:"
          wc -c "$PROVENANCE_DIR/provenance-${TAG}.json" || true
          echo "Provenance content:"
          cat "$PROVENANCE_DIR/provenance-${TAG}.json"

      - name: Upload artifact
        if: steps.resolve_tag.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: "provenance-${{ steps.resolve_tag.outputs.tag }}"
          path: "artifacts/slsa/${{ steps.resolve_tag.outputs.tag }}/provenance-${{ steps.resolve_tag.outputs.tag }}.json"
          retention-days: 90
