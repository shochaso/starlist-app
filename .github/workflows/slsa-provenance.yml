# Debug-enabled SLSA provenance workflow

name: slsa-provenance

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  packages: write

jobs:
  provenance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug: dump event and env
        run: |
          echo "=== GITHUB CONTEXT ==="
          jq . <<< "${{ toJson(github) }}" || true
          echo "=== GITHUB_EVENT (raw) ==="
          jq . < $GITHUB_EVENT_PATH || true
          echo "=== Release tag (jq) ==="
          jq -r '.release.tag_name // "NO_TAG_FOUND"' $GITHUB_EVENT_PATH || true
          echo "=== runner env summary ==="
          env | sort
          echo "=== which & versions ==="
          which git || true
          git --version || true
          if command -v cosign >/dev/null 2>&1; then cosign version || true; fi
          if command -v sbom-tool >/dev/null 2>&1; then sbom-tool --version || true; fi

      - name: Ensure tools / creds (debug)
        run: |
          echo "GITHUB_TOKEN: exists -> ${GITHUB_TOKEN:+yes}"  # do not echo token
          # show minimal API access check (non-sensitive)
          gh auth status || true
          # show current permissions granted to GITHUB_TOKEN (best-effort)
          gh api /rate_limit || true

      - name: Determine release tag
        id: tag
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [ -z "$TAG" ]; then
            echo "⚠️ github.event.release.tag_name is empty, trying git describe..."
            TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          fi
          if [ -z "$TAG" ]; then
            echo "⚠️ No release tag found, skipping provenance generation"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "✅ Using tag: $TAG"
          fi

      - name: Run provenance generation (real step)
        if: steps.tag.outputs.skip != 'true'
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          echo "Generating minimal provenance for tag: $TAG"
          mkdir -p provenance
          cat <<EOF > provenance/provenance.json
{
  "predicateType": "https://slsa.dev/provenance/v0.2",
  "builder": { "id": "github-actions/slsa-provenance" },
  "buildType": "https://github.com/${{ github.repository }}/actions/workflows/slsa-provenance.yml",
  "invocation": {
    "environment": "github",
    "workflow": "${{ github.workflow }}",
    "run_id": "${{ github.run_id }}",
    "release": "$TAG"
  },
  "metadata": {
    "buildInvocationId": "${{ github.run_id }}",
    "completeness": {
      "parameters": true,
      "environment": false,
      "materials": false
    }
  }
}
EOF
          echo "Provenance size:"
          wc -c provenance/provenance.json || true
          echo "Provenance content (first lines):"
          head -n 200 provenance/provenance.json || true

      - name: Upload provenance artifact
        if: steps.tag.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: provenance-${{ steps.tag.outputs.tag }}
          path: provenance/provenance.json
          retention-days: 90
