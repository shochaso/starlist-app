# Flutter App Startup Performance Check Workflow
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆãƒ»æ›´æ–°ã•ã‚Œã‚‹ãŸã³ã«ã€
# Flutterã‚¢ãƒ—ãƒªã®èµ·å‹•ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚’è‡ªå‹•ã§è¨ˆæ¸¬ã—ã¾ã™ã€‚
# è¦ä»¶å®šç¾©æ›¸ã«è¨˜è¼‰ã•ã‚ŒãŸã€Œèµ·å‹•æ™‚é–“3ç§’ä»¥å†…ã€ã¨ã„ã†åŸºæº–ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã€
# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®ä½Žä¸‹ã‚’æ—©æœŸã«æ¤œçŸ¥ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¾ã™ã€‚

name: Flutter Startup Performance Check

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  check_startup_performance:
    name: Check Startup Performance
    runs-on: ubuntu-latest

    steps:
      # Step 1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          # [ä¿®æ­£] ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸(google_maps_flutter)ãŒæ–°ã—ã„Dart SDKã‚’è¦æ±‚ã™ã‚‹ãŸã‚ã€
          # Flutterã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’'stable'ã‹ã‚‰'beta'ã«å¤‰æ›´ã—ã¾ã™ã€‚
          # ã“ã‚Œã«ã‚ˆã‚Šã€è¦ä»¶ã‚’æº€ãŸã™æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Dart SDKãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
          channel: 'beta'
          cache: true

      # Step 3: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: flutter pub get

      # Step 4: ã‚¢ãƒ—ãƒªã®èµ·å‹•ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å®Ÿè¡Œ
      # --profileãƒ¢ãƒ¼ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã—ã€èµ·å‹•ã«é–¢ã™ã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿
      # (start_up_info.json) ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
      # å˜ä¸€ãƒ‡ãƒã‚¤ã‚¹ï¼ˆchromeï¼‰å›ºå®šã§å®‰å®šåŒ–
      - name: Run startup trace
        continue-on-error: true  # OptionalåŒ–: å¤±æ•—ã—ã¦ã‚‚ãƒžãƒ¼ã‚¸ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
        run: flutter run --trace-startup --profile -d chrome

      # Step 5: èµ·å‹•æ™‚é–“ã‚’ç¢ºèªã—ã€ã—ãã„å€¤ã¨æ¯”è¼ƒ
      # ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ æç”»ã¾ã§ã®æ™‚é–“(timeToFirstFrameMicros)ã‚’
      # æŠ½å‡ºã—ã€è¦ä»¶å®šç¾©æ›¸ã®ã€Œ3ç§’ä»¥å†…ã€ã¨ã„ã†åŸºæº–ã¨æ¯”è¼ƒã—ã¾ã™ã€‚
      # OptionalåŒ–: å®Ÿæ©Ÿä¾å­˜ãƒ»ç’°å¢ƒå·®ã«ã‚ˆã‚Šä¸€æ™‚é™¤å¤–
      - name: Check startup time against threshold
        continue-on-error: true  # OptionalåŒ–: å¤±æ•—ã—ã¦ã‚‚ãƒžãƒ¼ã‚¸ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
        run: |
          # jqãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èµ·å‹•æ™‚é–“(ãƒžã‚¤ã‚¯ãƒ­ç§’)ã‚’å–å¾—
          startup_time_micros=$(jq '.timeToFirstFrameMicros' build/start_up_info.json)
          
          # ãƒžã‚¤ã‚¯ãƒ­ç§’ã‚’ãƒŸãƒªç§’ã«å¤‰æ›
          startup_time_ms=$((startup_time_micros / 1000))
          
          # è¦ä»¶å®šç¾©ã«åŸºã¥ãã€ã—ãã„å€¤ã‚’3000ãƒŸãƒªç§’(3ç§’)ã«è¨­å®š
          threshold_ms=3000
          
          echo "âœ… Measured startup time: $startup_time_ms ms"
          echo "Threshold: $threshold_ms ms"
          
          # è¨ˆæ¸¬ã•ã‚ŒãŸèµ·å‹•æ™‚é–“ãŒã—ãã„å€¤ã‚’è¶…ãˆã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          if (( startup_time_ms > threshold_ms )); then
            echo "::error::Startup time of $startup_time_ms ms exceeds the threshold of $threshold_ms ms."
            exit 1
          else
            echo "ðŸš€ Startup time is within the acceptable threshold."
          fi
