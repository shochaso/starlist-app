name: Ops Summary Email

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 1" # 毎週月曜 09:00 JST（UTC+9 → UTC 0:00）

permissions:
  contents: read

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      OPS_SERVICE_SECRET: ${{ secrets.OPS_SERVICE_SECRET }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      RESEND_FROM: ${{ secrets.RESEND_FROM }}
      RESEND_TO_LIST: ${{ secrets.RESEND_TO_LIST }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Show workflow ref
        run: |
          echo "GITHUB_REF_NAME=${GITHUB_REF_NAME}"

      - name: Validate required secrets
        run: |
          required=(SUPABASE_URL SUPABASE_ANON_KEY OPS_SERVICE_SECRET RESEND_API_KEY RESEND_FROM RESEND_TO_LIST)
          missing=0
          for v in "${required[@]}"; do
            if [ -z "${!v}" ]; then
              echo "::error title=Missing secret::$v is empty"
              missing=1
            fi
          done
          if [ $missing -ne 0 ]; then exit 1; fi

      - name: Normalize and resolve host
        id: dns
        shell: bash
        run: |
          RAW_URL="$SUPABASE_URL"
          # 前後の空白・改行を除去
          URL_TRIMMED="$(printf '%s' "$RAW_URL" | tr -d '\r' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          # 末尾のスラッシュ除去
          URL_NOSLASH="$(printf '%s' "$URL_TRIMMED" | sed -E 's#/*$##')"
          # ホスト名抽出
          HOST="$(printf '%s' "$URL_NOSLASH" | sed -E 's#^https?://([^/]+).*#\1#')"

          echo "SUPABASE_URL(normalized)=$URL_NOSLASH"
          echo "HOST=$HOST"

          # 形式検査
          if ! echo "$URL_NOSLASH" | grep -Eq '^https://[a-z0-9-]+\.supabase\.co$'; then
            echo "::error title=URL format error::Expected https://<project-ref>.supabase.co"
            exit 1
          fi

          # DNS解決
          getent hosts "$HOST" || { echo "::error title=DNS error::Failed to resolve $HOST"; exit 1; }

      - name: DryRun (preview HTML)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          set -euo pipefail
          set -x
          RESPONSE=$(curl --fail --show-error --retry 3 --retry-all-errors --max-time 30 \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "x-ops-secret: ${OPS_SERVICE_SECRET}" \
            -H "Content-Type: application/json" \
            "${SUPABASE_URL}/functions/v1/ops-summary-email?dryRun=true")
          echo "Response:"
          echo "$RESPONSE" | jq .
          echo "$RESPONSE" | jq -e '.ok == true and (.preview|length>0)' || exit 1
          echo "[ops-summary-email] dryrun success"

      - name: Send Weekly Email (prod)
        if: ${{ github.event_name == 'schedule' }}
        run: |
          set -euo pipefail
          RESPONSE=$(curl --fail --show-error --retry 3 --retry-all-errors --max-time 30 \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "x-ops-secret: ${OPS_SERVICE_SECRET}" \
            -H "Content-Type: application/json" \
            -X POST \
            "${SUPABASE_URL}/functions/v1/ops-summary-email" \
            -d '{}')
          echo "Response:"
          echo "$RESPONSE" | jq .
          echo "$RESPONSE" | jq -e '.ok == true' || exit 1
          echo "[ops-summary-email] weekly email sent"
