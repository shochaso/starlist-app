name: extended-security

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # 毎週月曜09:00 JST (00:00 UTC)
    - cron: '0 0 * * 1'

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  paths-filter:
    runs-on: ubuntu-latest
    outputs:
      docs_only: ${{ steps.filter.outputs.docs_only }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs_only:
              - 'docs/**'
              - '*.md'
              - '!lib/**'
              - '!supabase/**'
              - '!server/**'
              - '!.github/workflows/**'

  security-scan:
    needs: paths-filter
    if: ${{ needs.paths-filter.outputs.docs_only != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks

      - uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml','**/package-lock.json') }}
          restore-keys: trivy-${{ runner.os }}-

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install
        continue-on-error: true

      - name: Install security tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3-pip
          pipx ensurepath || python3 -m pip install --user pipx
          pipx install semgrep || python3 -m pip install semgrep || true
          curl -sfL https://raw.githubusercontent.com/gitleaks/gitleaks/master/install.sh | sudo bash -s -- -b /usr/local/bin || true
          sudo apt-get install -y trivy || true
        continue-on-error: true

      - name: Run Extended Security Runner
        env:
          SKIP_TRIVY_CONFIG: 1
        run: npm run -s security:ci
        continue-on-error: true

      - name: Upload gitleaks report
        if: always() && hashFiles('gitleaks-report.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 90
        continue-on-error: true

      - name: Upload Semgrep SARIF
        if: always() && hashFiles('semgrep.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true

      - name: Upload Trivy SARIF
        if: always() && hashFiles('trivy-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
        continue-on-error: true

      - name: Generate CycloneDX SBOM
        run: |
          # Install cyclonedx-npm if not available
          if ! command -v cyclonedx-npm >/dev/null 2>&1; then
            npm install -g @cyclonedx/cyclonedx-npm || echo "cyclonedx-npm install failed, using pnpm audit fallback"
          fi
          
          # Generate CycloneDX SBOM
          if command -v cyclonedx-npm >/dev/null 2>&1; then
            cyclonedx-npm --output-file sbom-cyclonedx.json || echo "cyclonedx-npm failed"
          fi
          
          # Fallback: pnpm audit JSON
          pnpm audit --json > sbom-pnpm.json || true
          echo "SBOM generated"
        continue-on-error: true

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom
          path: |
            sbom-cyclonedx.json
            sbom-pnpm.json
          retention-days: 90
        continue-on-error: true

      - name: RLS Audit (dry-run)
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          
          # Install Supabase CLI if not available
          if ! command -v supabase >/dev/null 2>&1; then
            npm install -g supabase || echo "supabase CLI install failed"
          fi
          
          # Run RLS audit SQL (dry-run)
          if command -v supabase >/dev/null 2>&1 && [ -n "${SUPABASE_URL:-}" ] && [ -n "${SUPABASE_ACCESS_TOKEN:-}" ]; then
            mkdir -p docs/reports
            supabase login --token "${SUPABASE_ACCESS_TOKEN}" || echo "Supabase login failed"
            
            # Execute RLS audit SQL and save to Markdown
            {
              echo "# RLS Audit Report"
              echo ""
              echo "**Generated**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              echo ""
              echo "## Tables without RLS enabled"
              echo ""
              echo "\`\`\`sql"
              supabase db query "$(cat scripts/rls_audit.sql | head -n 14)" --project-ref "$(echo $SUPABASE_URL | sed 's#https://\([^.]*\)\.supabase\.co#\1#')" || echo "Query failed"
              echo "\`\`\`"
              echo ""
              echo "## Tables with RLS but no policies"
              echo ""
              echo "\`\`\`sql"
              supabase db query "$(cat scripts/rls_audit.sql | tail -n +16)" --project-ref "$(echo $SUPABASE_URL | sed 's#https://\([^.]*\)\.supabase\.co#\1#')" || echo "Query failed"
              echo "\`\`\`"
            } > docs/reports/RLS_AUDIT_REPORT.md || echo "RLS audit report generation failed"
          else
            echo "⚠️  Supabase CLI or credentials not available. Skipping RLS audit."
          fi
        continue-on-error: true

      - name: Upload RLS Audit Report
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('docs/reports/RLS_AUDIT_REPORT.md') != ''
        with:
          name: rls-audit-report
          path: docs/reports/RLS_AUDIT_REPORT.md
          retention-days: 90
        continue-on-error: true

  security-scan-docs-only:
    needs: paths-filter
    if: ${{ needs.paths-filter.outputs.docs_only == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install
        continue-on-error: true

      - name: Install security tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3-pip
          pipx ensurepath || python3 -m pip install --user pipx
          pipx install semgrep || python3 -m pip install semgrep || true
          curl -sfL https://raw.githubusercontent.com/gitleaks/gitleaks/master/install.sh | sudo bash -s -- -b /usr/local/bin || true
          sudo apt-get install -y trivy || true
        continue-on-error: true

      - name: Run Semgrep (informational)
        run: |
          echo "docs-only: semgrep informational run"
          semgrep --config p/ci --severity INFO || true
        continue-on-error: true

      - name: Run Trivy (informational)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          severity: 'LOW,MEDIUM,HIGH,CRITICAL'
        continue-on-error: true

      - name: Run Gitleaks (informational)
        run: |
          echo "docs-only: gitleaks informational run"
          gitleaks detect --source . --report-path gitleaks-report.json --no-banner || true
        continue-on-error: true

      - name: Upload Semgrep SARIF (if exists)
        if: always() && hashFiles('semgrep.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true

      - name: Upload Trivy SARIF (if exists)
        if: always() && hashFiles('trivy-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
        continue-on-error: true

      - name: Upload gitleaks report (if exists)
        if: always() && hashFiles('gitleaks-report.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report-docs-only
          path: gitleaks-report.json
          retention-days: 90
        continue-on-error: true

      - name: Summary
        run: |
          echo "✅ docs-only PR: Security scans completed (informational only)"
          echo "This PR only changes docs/** and *.md files, so security checks are informational."
