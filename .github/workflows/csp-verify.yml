name: csp-verify
on:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  push:
    branches: [ main ]
  deployment_status:

jobs:
  verify:
    name: csp-verify
    runs-on: ubuntu-latest
    # PRでも実行。ただしSecret未設定のforkなどでは安全にスキップ
    if: >
      (github.event_name != 'pull_request')
      || (github.event.pull_request.head.repo.fork == false)
      || (secrets.CSP_VERIFY_URL != '')

    steps:
      - uses: actions/checkout@v4
      - name: Set target URL
        run: |
          echo "TARGET_URL=${{ secrets.CSP_VERIFY_URL || 'https://starlist.jp' }}" >> $GITHUB_ENV
      - name: Fetch headers
        run: |
          curl -sI "$TARGET_URL" | tr -d '\r' > headers.txt
          echo "---- HEADERS ----"
          cat headers.txt
      - name: Assert single CSP header
        run: |
          CNT=$(awk 'BEGIN{IGNORECASE=1} /^content-security-policy:/ {c++} END{print c+0}' headers.txt)
          test "$CNT" -eq 1 || { echo "Expected 1 CSP header, got $CNT"; exit 1; }
      - name: Assert key directives
        run: |
          H=$(awk 'BEGIN{IGNORECASE=1} /^content-security-policy:/ {print; exit}' headers.txt)
          miss=""
          for k in "default-src" "script-src" "object-src" "frame-ancestors"; do
            echo "$H" | grep -qi "$k" || miss="$miss $k"
          done
          if [ -n "$miss" ]; then
            echo "Missing directives:$miss"
            exit 1
          fi
      - name: Summarize
        run: |
          echo "CSP verified ✅ at $TARGET_URL"
