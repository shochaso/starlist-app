name: Phase 4 Auto-Audit

on:
  schedule:
    - cron: '0 6 * * *' # Daily at 06:00 UTC
  workflow_dispatch:
    inputs:
      window_days:
        description: 'Number of days to look back'
        required: false
        default: '7'
        type: string
      run_mode:
        description: 'Run mode (full|observer|collector|kpi)'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - observer
          - collector
          - kpi

jobs:
  guard:
    name: Secrets Guard
    uses: ./.github/workflows/phase4-retry-guard.yml
    secrets: inherit

  observer:
    name: Observer 2.0
    needs: guard
    if: needs.guard.outputs.guard-passed == 'true' && (github.event.inputs.run_mode == 'full' || github.event.inputs.run_mode == 'observer' || github.event.inputs.run_mode == '')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run Observer 2.0
        env:
          NODE_ENV: production
          WINDOW_DAYS: ${{ github.event.inputs.window_days || '7' }}
          RUN_ID: ${{ github.event.inputs.run_id }}
          REPORT_DIR: docs/reports/2025-11-14
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run phase4:observer

  collector:
    name: Evidence Collector
    needs: guard
    if: needs.guard.outputs.guard-passed == 'true' && (github.event.inputs.run_mode == 'full' || github.event.inputs.run_mode == 'collector' || github.event.inputs.run_mode == '')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run Collector
        env:
          NODE_ENV: production
          REPORT_DIR: docs/reports/2025-11-14
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run phase4:collect

  kpi:
    name: KPI Aggregator
    needs: [observer, collector]
    if: always() && (github.event.inputs.run_mode == 'full' || github.event.inputs.run_mode == 'kpi' || github.event.inputs.run_mode == '')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run KPI Aggregator
        env:
          NODE_ENV: production
          REPORT_DIR: docs/reports/2025-11-14
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          npm run phase4:kpi

