name: phase4-auto-audit

on:
  workflow_dispatch:
    inputs:
      window_days:
        description: "Number of days the observer should evaluate"
        required: false
        default: "7"
      run_mode:
        description: "Execution mode (normal|dry-run)"
        required: false
        default: "normal"
  schedule:
    - cron: "30 2 * * *" # Daily observation window (UTC)

permissions:
  contents: read

jobs:
  preflight-guards:
    runs-on: ubuntu-latest
    steps:
      - name: Validate required secrets presence
        env:
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          missing=()
          if [ -z "${SUPABASE_SERVICE_KEY:-}" ]; then
            missing+=("SUPABASE_SERVICE_KEY")
          fi
          if [ -z "${SLACK_WEBHOOK_URL:-}" ]; then
            missing+=("SLACK_WEBHOOK_URL")
          fi
          if [ "${#missing[@]}" -gt 0 ]; then
            printf '::error::Missing required secrets: %s\n' "${missing[*]}"
            printf 'Ensure secrets are configured before running Phase 4 auto audit. Values are not printed.\n'
            exit 1
          fi
          echo "Required secrets detected. Proceed without exposing values."

  schema-validate:
    runs-on: ubuntu-latest
    needs:
      - preflight-guards
    steps:
      - uses: actions/checkout@v4

      - name: Ensure Phase 4 schema artifacts exist
        run: |
          set -euo pipefail
          REQUIRED_TXT="docs/reports/2025-11-14/RUNS_SUMMARY.schema.txt"
          if [ ! -f "$REQUIRED_TXT" ]; then
            echo "::error::Missing schema guidance file: $REQUIRED_TXT"
            exit 1
          fi
          echo "Found schema guidance at $REQUIRED_TXT"

      - name: Validate RUNS_SUMMARY.json when present
        run: |
          set -euo pipefail
          SUMMARY_JSON="docs/reports/2025-11-14/RUNS_SUMMARY.json"
          if [ -f "$SUMMARY_JSON" ]; then
            jq '.' "$SUMMARY_JSON" >/dev/null
            echo "RUNS_SUMMARY.json parsed successfully."
          else
            echo "RUNS_SUMMARY.json not present yet. Skipping JSON validation."
          fi

  collect-and-observe:
    runs-on: ubuntu-latest
    needs:
      - schema-validate
    steps:
      - uses: actions/checkout@v4

      - name: Display execution parameters
        run: |
          echo "Phase 4 auto audit starting."
          echo "window_days=${{ inputs.window_days || '7' }}"
          echo "run_mode=${{ inputs.run_mode || 'normal' }}"

      - name: Placeholder - invoke collection & observer scripts
        run: |
          echo "Collection and observer scripts will be wired in Step 4/5/6 implementation."
          echo "Refer to scripts/phase4-auto-collect.sh and scripts/phase4-observer-report.sh once available."
