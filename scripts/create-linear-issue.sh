#!/usr/bin/env bash
# Linear APIã‚’ä½¿ç”¨ã—ã¦Issueã‚’ä½œæˆã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ä½¿ç”¨ä¾‹: ./scripts/create-linear-issue.sh STA-8 "Production flow smoke test"

set -euo pipefail
IFS=$'\n\t'

usage() {
  cat <<'USAGE'
Usage: ./scripts/create-linear-issue.sh <ISSUE_KEY> "<TITLE>" [API_KEY]

ISSUE_KEY  : Linear ã® Issue ã‚­ãƒ¼ï¼ˆä¾‹: STA-8ï¼‰ã€‚ç’°å¢ƒå¤‰æ•° LINEAR_ISSUE_KEY ã‹ã‚‰ã‚‚æŒ‡å®šå¯ã€‚
TITLE      : Issue ã‚¿ã‚¤ãƒˆãƒ«ã€‚LINEAR_ISSUE_TITLE ã‚’è¨­å®šã—ã¦ãŠãã¨çœç•¥ã§ãã¾ã™ã€‚
API_KEY    : 3ç•ªç›®ã®å¼•æ•°ã§ API ã‚­ãƒ¼ã‚’æ¸¡ã™ã¨ LINEAR_API_KEY ã‚ˆã‚Šå„ªå…ˆã•ã‚Œã¾ã™ã€‚

Environments:
  LINEAR_API_KEY          : Linear Personal API keyï¼ˆå¿…é ˆï¼‰
  LINEAR_TEAM_ID          : æ—¢å­˜ Team ã® ID ã‚’æŒ‡å®šã™ã‚‹ã¨ãƒãƒ¼ãƒ ä¸€è¦§ã®å•ã„åˆã‚ã›ã‚’çœç•¥
  LINEAR_ISSUE_DESCRIPTION : {{ISSUE_KEY}} ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’å«ã‚ã¦æœ¬æ–‡ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

LINEAR_ISSUE_DESCRIPTION ä¾‹: $'Issue {{ISSUE_KEY}} generated by CI\n- smoke test'

æ”¹è¡Œã‚’å«ã‚€å ´åˆã¯ $'...' å½¢å¼ã‚’ä½¿ç”¨:
  export LINEAR_ISSUE_DESCRIPTION=$'{{ISSUE_KEY}}: title here\n- bullet point'

Use -h|--help to show this message again.
USAGE
}

require_command() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "âŒ Error: '$1' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚" >&2
    exit 1
  fi
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

ISSUE_KEY="${1:-${LINEAR_ISSUE_KEY:-}}"
TITLE="${2:-${LINEAR_ISSUE_TITLE:-}}"
API_KEY="${3:-${LINEAR_API_KEY:-}}"

if [[ -z "$ISSUE_KEY" || -z "$TITLE" ]]; then
  echo "Usage: $0 <ISSUE_KEY> \"<TITLE>\" [API_KEY]"
  echo ""
  echo "ä¾‹: ./scripts/create-linear-issue.sh STA-8 \"Production flow smoke test\""
  echo ""
  echo "API_KEYãŒæŒ‡å®šã•ã‚Œãªã„å ´åˆã€LINEAR_API_KEYç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
  echo "DESCRIPTIONã¯LINEAR_ISSUE_DESCRIPTIONã§èª¿æ•´å¯èƒ½ï¼ˆ{{ISSUE_KEY}}ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€å¯¾å¿œï¼‰ã€‚"
  exit 1
fi

require_command "curl"
require_command "jq"

if [[ -z "$API_KEY" ]]; then
  echo "âŒ Error: Linear APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚"
  echo ""
  echo "ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã§APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š"
  echo "1. ç’°å¢ƒå¤‰æ•°: export LINEAR_API_KEY='your-api-key'"
  echo "2. å¼•æ•°ã¨ã—ã¦æ¸¡ã™: $0 $ISSUE_KEY \"$TITLE\" 'your-api-key'"
  echo ""
  echo "Linear APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•:"
  echo "1. Linearã«ãƒ­ã‚°ã‚¤ãƒ³"
  echo "2. Settings > API > Personal API keys"
  echo "3. æ–°ã—ã„ã‚­ãƒ¼ã‚’ç”Ÿæˆ"
  exit 1
fi

DESCRIPTION_TEMPLATE="${LINEAR_ISSUE_DESCRIPTION:-Created via Linear API automation for {{ISSUE_KEY}}}"
DESCRIPTION="${DESCRIPTION_TEMPLATE//\{\{ISSUE_KEY\}\}/${ISSUE_KEY}}"

TEAM_KEY="${ISSUE_KEY%%-*}"
if [[ -z "$TEAM_KEY" ]]; then
  TEAM_KEY="$ISSUE_KEY"
fi

LINEAR_TEAM_ID="${LINEAR_TEAM_ID:-}"
if [[ -n "$LINEAR_TEAM_ID" ]]; then
  TEAM_ID="$LINEAR_TEAM_ID"
  echo "â„¹ï¸ LINEAR_TEAM_ID ç’°å¢ƒå¤‰æ•°ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ãƒãƒ¼ãƒ ä¸€è¦§å•ã„åˆã‚ã›ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚"
else
  echo "ğŸ” ãƒãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—ä¸­..."
  TEAMS_PAYLOAD=$(jq -n --arg query 'query { teams { nodes { id name key } } }' '{ query: $query }')
  set +e
  TEAMS_RESPONSE=$(curl --fail-with-body -sS -X POST https://api.linear.app/graphql \
    -H "Content-Type: application/json" \
    -H "Authorization: ${API_KEY}" \
    -d "$TEAMS_PAYLOAD")
  TEAMS_EXIT=$?
  set -e
  if [[ $TEAMS_EXIT -ne 0 ]]; then
    echo "âŒ Error: ãƒãƒ¼ãƒ æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ $TEAMS_EXIT"
    echo "Response: $TEAMS_RESPONSE"
    exit 1
  fi

  echo "$TEAMS_RESPONSE" | jq -r '.data.teams.nodes[] | "\(.key): \(.name) (ID: \(.id))"' || {
    echo "âŒ Error: ãƒãƒ¼ãƒ æƒ…å ±ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
    echo "Response: $TEAMS_RESPONSE"
    exit 1
  }

  TEAM_ID=$(echo "$TEAMS_RESPONSE" | jq -r ".data.teams.nodes[] | select(.key == \"${TEAM_KEY}\") | .id")
fi

if [[ -z "${TEAM_ID:-}" ]]; then
  echo "âŒ Error: ãƒãƒ¼ãƒ  '${TEAM_KEY}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
  exit 1
fi

echo ""
echo "ğŸ“ Issueä½œæˆä¸­: ${ISSUE_KEY} - ${TITLE}"
echo "âœ… ãƒãƒ¼ãƒ ID: ${TEAM_ID}"

QUERY='mutation ($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier title url } } }'
REQUEST_PAYLOAD=$(jq -n \
  --arg query "$QUERY" \
  --arg team "$TEAM_ID" \
  --arg title "$TITLE" \
  --arg description "$DESCRIPTION" \
  '{ query: $query, variables: { input: { teamId: $team, title: $title, description: $description } } }')

set +e
CREATE_RESPONSE=$(curl --fail-with-body -sS -X POST https://api.linear.app/graphql \
  -H "Content-Type: application/json" \
  -H "Authorization: ${API_KEY}" \
  -d "$REQUEST_PAYLOAD")
CREATE_EXIT=$?
set -e

if [[ $CREATE_EXIT -ne 0 ]]; then
  echo "âŒ Error: Issueä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ $CREATE_EXITï¼‰ã€‚"
  echo "Response: $CREATE_RESPONSE"
  exit 1
fi

# GraphQLã‚¨ãƒ©ãƒ¼ã®è©³ç´°è¡¨ç¤º
ERROR_MESSAGES=$(echo "$CREATE_RESPONSE" | jq -r '.errors[]?.message // empty' 2>/dev/null || true)
if [[ -n "$ERROR_MESSAGES" ]]; then
  echo "âŒ Linear API error(s):" >&2
  echo "$ERROR_MESSAGES" >&2
  # ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ãƒ­ã‚°ã«ä¿å­˜
  echo "$CREATE_RESPONSE" | jq . > "out/linear_error_$(date +%Y%m%d_%H%M%S).json" 2>/dev/null || true
  exit 1
fi

SUCCESS=$(echo "$CREATE_RESPONSE" | jq -r '.data.issueCreate.success // false')
ISSUE_ID=$(echo "$CREATE_RESPONSE" | jq -r '.data.issueCreate.issue.identifier // empty')
ISSUE_URL=$(echo "$CREATE_RESPONSE" | jq -r '.data.issueCreate.issue.url // empty')

if [[ "$SUCCESS" == "true" && -n "$ISSUE_ID" ]]; then
  # æˆåŠŸæ™‚ã®1è¡Œãƒˆãƒ¼ã‚¹ãƒˆï¼ˆSOTè²¼ã‚Šä»˜ã‘ç”¨ï¼‰
  echo "âœ… Linear: created ${ISSUE_ID} ${ISSUE_URL}"
  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ­ã‚°ã«ä¿å­˜
  mkdir -p "out/linear/$(date +%Y-%m-%d)"
  echo "$CREATE_RESPONSE" | jq . > "out/linear/$(date +%Y-%m-%d)/create_response_${ISSUE_ID}.json" 2>/dev/null || true
else
  echo "âŒ Error: Issueä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚" >&2
  echo "Response: $CREATE_RESPONSE" >&2
  exit 1
fi
