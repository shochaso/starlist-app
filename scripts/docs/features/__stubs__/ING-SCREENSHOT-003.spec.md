---

spec_id: ING-PIPE-OCR-ONEPAGER

scope: Ingest Pipeline／OCR／スクリーンショット解析

status: draft

source_of_truth: true

last_updated: 2025-11-07 JST

relates:

  - ING-PIPE-CORE-001

  - ING-OCR-IMAGE-002

  - ING-SCREENSHOT-003

  - ING-YT-PIPE-004

owners:

  - pm: Tim

  - impl: Mine

review_flow: AI(ingestプリセット) -> Tim(最終)

---

# 要約（まずここだけ読めばOK）

- **目的：**  

  スターやユーザーがアップした「レシート」「スクショ」「YouTube履歴」を安全・正確に取り込む。  

  同じ画像や個人情報を誤って共有しないよう、全工程を自動チェック。

- **核となる機能：**

  ① 重複防止（checksum／phash）  

  ② PII自動マスキング（個人情報を隠す）  

  ③ OCR解析＋信頼度閾値  

  ④ タイムアウト時のみ再試行  

  ⑤ 全操作を監査ログに残す

---

## パイプライン概要（非エンジニア向け）

1. 画像やスクショをアップすると、まず**重複判定**。  

   → 同じ内容（phash閾値95%以上）は**弾かれる**。

2. 次に**OCR解析**。  

   - 文字抽出後、信頼度が70%未満なら再解析を1回まで。  

   - メール・電話・住所は `<PII:*>` に置換。

3. 解析結果をSupabaseへ保存。  

   - **署名URL（60秒）**で購読者だけが閲覧できる。  

   - 閲覧・再試行・失敗もすべて `audit_ingest` に記録。

`code_refs:` ingest function / OCR worker / phash util : `<TODO>`

---

## 冪等性・再試行ルール

- **冪等性:** 同じファイル名＋サイズ＋hash は1回だけ記録  

- **再試行:** TIMEOUT のみ指数バックオフ（3回上限）  

- **例外:** 認証エラー／APIキー不備は再試行しない

`code_refs:` retry logic / error enum : `<TODO>`

---

## PIIマスキング（対象・除外）

| 種類 | 正規表現例 | 置換後 | 備考 |

|:--|:--|:--|:--|

| メール | `[A-Z0-9._%+-]+@[A-Z0-9.-]+` | `<PII:EMAIL>` | |

| 電話番号 | `0\d{1,4}-\d{1,4}-\d{4}` | `<PII:TEL>` | |

| 住所 | `〒?\d{3}-\d{4}` など | `<PII:ADDR>` | |

| 除外 | SNSハンドル・商品名 | - | 変換しない |

`code_refs:` pii_mask util : `<TODO>`

---

## 監査ログ（audit_ingest）

| 列名 | 型 | 説明 |

|:--|:--|:--|

| id | uuid | 一意ID |

| user_id | uuid | 実行者 |

| source_type | text | receipt / screenshot / youtube |

| result | jsonb | 解析結果 |

| duration_ms | int | 処理時間 |

| retries | int | 再試行回数 |

| error | text | 最終エラー内容 |

| created_at | timestamptz | 記録時刻 |

`code_refs:` audit_ingest schema : `<TODO>`

---

## テレメトリ（可視化）

- 成功率・平均処理時間・再試行率をダッシュボード化  

- Cloudflare Analytics + Supabase Log Export で自動収集  

- 閾値逸脱は Slack 通知

`code_refs:` telemetry config : `<TODO>`

---

## この1ページのゴール

データ取り込みが「**二度と同じ画像を登録しない／個人情報を残さない／障害が追える**」状態に。  

4本の Ingest 仕様を `source_of_truth:true` に昇格し、Day3完了＝仕様20本コンプリートへ。

---

# スクリーンショット処理仕様

## 目的 / スコープ

- ユーザーがアップロードしたスクリーンショット画像から有用な情報を抽出し、構造化データとして保存
- モバイルアプリ・Webブラウザのスクリーンショットを対象とした特化処理を実装

## スクリーンショット特性

### 入力パターン
- **モバイルアプリ**: iOS/Androidの各種アプリ画面
- **Webブラウザ**: Chrome/Safari/Firefox等のブラウザ画面
- **OS設定画面**: システム設定、通知、権限画面
- **メッセージアプリ**: LINE, Twitter, Instagram等の画面

### 処理課題
- **UI要素除去**: ヘッダー・フッター・ナビゲーションバーの除去
- **文字密度**: 通常画像より高密度の文字配置
- **背景ノイズ**: グラデーション・パターン・アイコン等の妨害要素
- **解像度変動**: デバイス・設定により異なる解像度

## 画像前処理

### 領域検出
- **ヘッダー除去**: 上部20-30%を自動検出して除去
- **フッター除去**: 下部10-20%を自動検出して除去
- **サイドバー除去**: 左右の余白を自動検出して除去
- **コンテンツ領域**: 主要な文字領域を特定

### ノイズ除去
- **UI要素マスク**: ボタン・アイコン・装飾要素の除去
- **背景平滑化**: グラデーション・パターンの除去
- **コントラスト調整**: 文字の読みやすさ向上
- **二値化**: 文字領域の明確化

## OCR最適化

### レイアウト認識
- **段落構造**: テキストブロックのグループ化
- **表構造**: 表形式データの検出と構造化
- **リスト構造**: 箇点・番号付きリストの認識
- **フォーム構造**: 入力欄・選択肢の検出

### 文字認識改善
- **フォント統一**: UIフォントを標準フォントに変換
- **サイズ正規化**: 文字サイズの統一化
- **間隔調整**: 文字間・行間の最適化
- **言語判定**: 日本語/英語の自動切り替え

## スクリーンショット特化処理

### アプリ別最適化
```json
{
  "ios_safari": {
    "header_height": "20%",
    "remove_elements": ["url_bar", "tab_bar"],
    "focus_area": "content_viewport"
  },
  "android_chrome": {
    "header_height": "15%",
    "remove_elements": ["address_bar", "navigation_bar"],
    "focus_area": "web_content"
  }
}
```

### 一般UIパターン
- **ステータスバー除去**: 時刻・バッテリー・電波表示の除去
- **ナビゲーション除去**: 戻るボタン・ホームボタンの除去
- **キーボード除去**: ソフトウェアキーボード表示時の除去
- **ポップアップ除去**: アラート・メニュー表示の除去

## データ構造化

### 抽出対象
- **テキストコンテンツ**: 記事本文・コメント・説明文
- **構造化データ**: 表・リスト・フォーム
- **メタ情報**: URL・タイトル・タイムスタンプ
- **ユーザー情報**: 投稿者名・プロフィール情報

### 出力フォーマット
```json
{
  "metadata": {
    "source_type": "screenshot",
    "app_type": "mobile_browser",
    "capture_time": "2025-11-07T10:30:00Z"
  },
  "content": {
    "title": "記事タイトル",
    "body": "本文テキスト...",
    "structured_data": {
      "tables": [...],
      "lists": [...],
      "forms": [...]
    }
  },
  "pii_detected": [
    {"type": "email", "original": "user@example.com", "masked": "<PII:EMAIL>"}
  ]
}
```

## エラー処理

### スクリーンショット特化エラー
- **低品質画像**: 文字が小さすぎる・ぼやけている
- **UI重複**: 同じ画面の複数回キャプチャ
- **部分キャプチャ**: 重要な情報が切れている
- **加工画像**: 編集されたスクリーンショット

### 回復戦略
- **品質チェック**: 事前検証で低品質を拒否
- **再キャプチャ誘導**: ユーザーへの改善指示
- **部分解析**: 可能な範囲で情報を抽出
- **手動処理**: 重要コンテンツの手動入力

## パフォーマンス最適化

### 処理高速化
- **GPU活用**: OCR処理のGPUアクセラレーション
- **キャッシュ**: 同一パターンの前処理結果保存
- **並行処理**: 複数画像の同時処理
- **ストリーミング**: 大容量画像の分割処理

### コスト最適化
- **API最適化**: 不要なAPI呼び出しの削減
- **前処理効率**: 無駄な画像処理の回避
- **結果キャッシュ**: 重複画像の再処理防止
- **動的スケーリング**: 需要に応じたリソース調整

## 品質評価

### 自動評価指標
- **文字認識率**: 抽出テキストの正確性
- **構造化精度**: 表・リストの正しい認識
- **PII検出率**: 個人情報の適切なマスキング
- **コンテンツ完全性**: 主要情報の欠落度

### 手動評価基準
- **可読性**: 人間が読みやすいテキスト変換
- **文脈保持**: 原文の意味・構造の維持
- **ノイズ除去**: UI要素の適切な除去
- **実用性**: 業務で使える情報抽出

## セキュリティ考慮

### データ保護
- **PII自動検出**: スクリーンショット内の個人情報検出
- **即時マスキング**: アップロード時の自動置換
- **アクセス制御**: 署名URLによる一時アクセス
- **監査追跡**: 全処理操作のログ記録

### プライバシー保護
- **同意確認**: スクリーンショットアップロード時の警告
- **データ最小化**: 必要な情報のみの抽出・保存
- **即時削除**: 処理完了後の元画像削除
- **暗号化**: 保存データの暗号化

## テスト戦略

### 単体テスト
- UI除去アルゴリズムの正確性
- OCR精度のスクリーンショット別評価
- PII検出のパターン網羅性

### 統合テスト
- エンドツーエンド処理フロー
- 複数デバイス対応検証
- API制限下での動作確認

### E2Eテスト
- 実際のスクリーンショットでの処理検証
- モバイルアプリからのアップロードフロー
- 購読者権限でのアクセス制御
